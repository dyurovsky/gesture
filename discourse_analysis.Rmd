---
title: "Discourse analysis"
author: " Maddie Meyers and Dan Yurovsky"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: false
    number_sections: false
    theme: lumen
    toc_float: false
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(langcog)
library(stringr) 
library(lme4)
library(directlabels)
library(DT)
library(broom)
library(data.table)
library(ggplot2)
library(forcats)
library(feather)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = TRUE, tidy = FALSE)

theme_dy <- function(base_size = 14) 
{
  theme_bw() +   
  ggplot2::`%+replace%`(ggplot2::theme_bw(base_size = base_size),
                          ggplot2::theme(panel.grid = ggplot2::element_blank(), 
        legend.position = "none"))
}

theme_set(theme_dy())
```

## R Markdown

Setting up data
```{r load_data}
# Original data
loaded_subjs <- read_feather("feathers/loaded_subjs.feather")
# Referents and their frequencies
referents <- read_feather("feathers/referents.feather")
# End result of splitting referents and coding modality
coded_responses <- read_feather("feathers/coded_responses.feather")
```

Split referents up 

```{r split_ref}
spread_refs <- function(df) {
  
  max_refs <- df %>%
    ungroup() %>%
    gather(ref_col, refs, spoken_obj, gestured_obj, referent) %>%
    mutate(num_refs = str_count(refs,";")) %>%
    summarise(num_refs = max(num_refs, na.rm = T)+1) %>%
    as.integer()
    
  ref_list <- sapply(1:max_refs,function(x) paste0("referent",x))
  
  spread_referents <- df %>%
    separate_("referent", ref_list, sep = ";", fill = "right") %>%
    gather_("number", "referent", ref_list) %>%
    filter(!is.na(referent)) %>%
    mutate(referent = str_trim(referent))
  
  spread_referents %>%
    mutate(spoken_obj = map(str_split(spoken_obj, ";"), str_trim),
           gestured_obj = map(str_split(gestured_obj, ";"), str_trim)) %>%
    rowwise() %>%
    mutate(spoken = purrr::has_element(spoken_obj[[1]], referent),
           gestured = purrr::has_element(gestured_obj[[1]], referent),
           both = spoken & gestured) %>%
    ungroup() %>%
    mutate(modality = if_else(spoken & gestured, "both", 
                              if_else(spoken, "speech", "gesture"))) %>%
    select(time, time2, sample, subj, age, person, referent, modality, chat, gloss) %>%
    left_join(referents) %>%
    mutate(freq_cut = cut(log(freq), 4))
}
```

## Sampling/discourse analysis

Sample subsections of the corpus to look at how new referents enter the discourse

```{r ref_density}
# Takes a data frame (grouped), a consecutive sample size (e.g. 10 rows), and a number of samples (e.g. 20 samples) and returns a sub-sampled dataframe with a new column "sample" that indicates the sample number

split_df <- function(df, size, count) {
 nrows <- df %>% 
   summarise(n = n()) %>% 
   ungroup() %>% 
   select(n) %>% 
   min
  
 num_splits <- floor(nrows / size)
 
 split_list <- map(1:num_splits, function(n) (n-1)*size + 1:size) %>%
   sample(., count)
 
 samples <- map(split_list, function(n) df %>% slice(n))
 
 sampled_df <- map(1:length(samples), 
                   function(n) mutate(samples[[n]], sample = n)) %>%
   bind_rows()
}
```

```{r first_refs}

sampled_subjs <- loaded_subjs %>%
  group_by(subj, age) %>%
  split_df(., 16, 30) %>%
  spread_refs()

#now want to see how many referents in the discourse are first referents and plot those averages 
first_data <- coded_responses %>%
  group_by(subj, age, referent) %>%
  slice(1) %>% 
  mutate(first = TRUE) 

not_first_data <- coded_responses %>%
  group_by(subj, age, referent) %>%
  slice(2:nrow(.)) %>% 
  mutate(first = FALSE)

first_ref <- sampled_subjs %>%
  mutate(isFirst = ifelse(time2 %in% first_data$time2, "first","not first")) %>%
  group_by(subj, age, sample, isFirst, person, modality) %>%
  summarise(count=sum(is.na(referent)==FALSE))

first_ref_all <- first_ref %>%
  group_by(isFirst, age, person, subj) %>%
  summarise(count = mean(count)) %>%
  summarise(mean = mean(count, na.rm = T),
            sem = sem(count, na.rm = T))

first_ref_modality <- first_ref %>%
  group_by(isFirst, age, person, modality, subj) %>%
  summarise(count = mean(count)) %>%
  summarise(mean = mean(count, na.rm = T),
            sem = sem(count, na.rm = T))
            

ggplot(first_ref_all, aes(x = age, y = mean, color = isFirst, label = isFirst)) + 
  facet_wrap(~person) +
  geom_pointrange(aes(ymin = mean - sem, ymax = mean+sem)) +
  ylab("refs per 16 utterances") + 
  scale_color_brewer(palette = "Set1") + 
  geom_dl(method = list(dl.trans(x=x +.2), "last.qp", cex=1)) +
  scale_x_continuous(limits = c(12, 30))

ggplot(first_ref_modality, aes(x= age, y = mean, color = isFirst, label = isFirst)) + 
  facet_grid(modality~person) +
  geom_pointrange(aes(ymin = mean - sem, ymax = mean+sem)) +
  ylab("refs per 16 utterances") + 
  scale_color_brewer(palette = "Set1") + 
  geom_dl(method = list(dl.trans(x=x +.2), "last.qp", cex=1)) +
  scale_x_continuous(limits = c(12, 30))
```

## Comparisons to previous discourse analyses 

In the Frank et al discourse paper, they defined a discourse to be 3 or more continued references to the same referent. While this is a flawed definition of discourse, I was curious to see how many discourses were in our data set

```{r Frank discourse}
discourse_amt <- coded_responses %>%
  mutate(lag_ref = lag(referent),
         lag_lag_ref = lag(lag_ref)) %>%
  filter(referent == lag_ref, 
         lag_lag_ref == lag_ref) %>% #filter for strings of at least 3 same referent 
  filter(referent != lag(referent)) %>% # grab first of each run
  group_by(subj, age, referent, time) %>% 
  slice(1) %>% 
  group_by(age, subj) %>%
  summarise(n = n()) %>%
  summarise(mean = mean(n), sem = sem(n))

ggplot(discourse_amt, aes(x = age, y= mean)) +
  geom_pointrange(aes(ymin = mean - sem, ymax = mean +sem), color = "darkred") + 
  ylab("Number of Referent")
```

It seems like there are the most strings of at least 3 of same referent at age 22mos, not other months! interesting (not sure if coded completely right, definitely took some shortcuts)

Probably need to normalize by total number of refernts

How do these data compare to Frank et al? They used only speech data with a much smaller sample of referents, 5-15 minute lengths of play (how long are ours?) with a total corpus of 5,000 utterances (smaller) and found 6mos=88 discourse, 12mos=110, 18mos=107. We would expect them to have more repeated discourses because they have many fewer potential referents. This seems to be the case, because even though we have more discourses, they may not have been coded correctly (overestimates) and the corpus is much, much larger 

```{r}
discourse_2<-coded_responses %>%
  mutate(lag_ref=lag(referent),
         lag_lag_ref=lag(lag_ref)) %>%
  filter(referent==lag_ref, lag_lag_ref == lag_ref) %>% #filter for strings of at least 3 same referent 
  group_by(subj, age, referent, time) %>%
  slice(1) %>%
  filter(subj==33, age==22, time >500)

ggplot(aes(x = time, y = referent, fill =  interaction(person,modality)), data = discourse_2) + 
  geom_tile(color = "black") + 
  theme(legend.position = "bottom")

```

Finally, a gletiman plot that looks readable! 

Discourse success = same referent in succession mentioned by different person (mom/child talking about same thing with concrete noun included)

Try first without real discourse structure (all NAs are excluded) using coded_responses data. Also helps reduce probelms b/c pronoun-only sentences are excluded, though there may be multiple referent with one mentioned as pronoun issue 
```{r discourse success}
discourse_success <- coded_responses %>%
  mutate(isFirst = if_else(time2 %in% first_data$time2, "first", "not first")) %>% 
  mutate(success = if_else(lag(person) != person & lag(referent) == referent, "success",
                          if_else(lag(person) != person & lag(referent) !=referent, "switch",
                                  if_else(lag(referent) == referent, "repeat", 
                                          "same_per_swtich")))) %>%
  filter(!is.na(success))
```

plot of discourse successes looks similar to plots of #of referents per age, which is interesting because you would think there would be most successful utterances for the oldest kids 

```{r discourse_success_plot}
ggplot(discourse_success, aes(x=age, fill=person)) + 
  facet_wrap(~success)+
  geom_bar(position = "dodge")+
  theme(legend.position="bottom") + 
  scale_fill_brewer(palette = "Set1") +
  ggtitle("discourse type (individual or interaction) by referent stability (same or different)")
```

Does parent discourse responsiveness stay constant over age? Or is it larger for small children? See proportion of successes over proportion of switches 
```{r }
discourse_prop <- discourse_success %>%
  group_by(age, person, success) %>%
  summarise(n=n()) %>%
  group_by(age) %>%
  mutate(prop= n/sum(n))

ggplot(discourse_prop, aes(x=age, y=prop, fill=person)) + 
  facet_wrap(~success) + 
  geom_bar(stat= "identity", position="dodge") + 
  theme(legend.position="bottom") + 
  ggtitle("discourse proportion between person")
```

Shows what proportion of time parents or children are spending with each kind of discourse (be careful about interpreting)
```{r}
discourse_prop2 <- discourse_success %>%
  group_by(person, age, success) %>%
  summarise(n=n()) %>%
  mutate(prop= n/sum(n))

ggplot(discourse_prop2, aes(x=age, y=prop, fill = success)) + 
  facet_wrap(~person) + 
  geom_bar(stat="identity", position="dodge") + 
  theme(legend.position="bottom") + 
  ggtitle("proportion of time person spends using discourse type") + 
  scale_fill_brewer(palette = "Set1")
```

What happens when the referent is first introduced into the session? How does that change the effects we have seen

not sure if we find anything meaningful here...
```{r discourse first}
first_success<-coded_responses %>%
  mutate(isFirst = ifelse(time2 %in% first_data$time2, "first","not first")) %>% 
  mutate(success = ifelse(lead(person) != person & lead(referent)==referent, "success", ifelse(lead(person) != person & lead(referent) !=referent, "switch", ifelse(lead(referent)==referent, "repeat", "same_per_swtich")))) %>%
  filter(is.na(success)==FALSE) %>%
  filter(isFirst=="first")

not_first_success<-coded_responses %>%
  mutate(isFirst = ifelse(time2 %in% first_data$time2, "first","not first")) %>% 
  mutate(success = ifelse(lead(person) != person & lead(referent)==referent, "success", ifelse(lead(person) != person & lead(referent) !=referent, "switch", ifelse(lead(referent)==referent, "repeat", "same_per_swtich")))) %>%
  filter(is.na(success)==FALSE) %>%
  filter(isFirst=="not first")

ggplot(aes(x=age, fill=person), data=first_success)+geom_bar(position="dodge")+theme(legend.position="bottom")+facet_wrap(~success)+ggtitle("discourse type (individual or interaction) by referent stability (same or different)", subtitle="first")
ggplot(aes(x=age, fill=person), data=not_first_success)+geom_bar(position="dodge")+theme(legend.position="bottom")+facet_wrap(~success)+ggtitle("discourse type (individual or interaction) by referent stability (same or different)", subtitle="not first")
```

```{r discourse modality}
#see if there is anything meaningful about modality here 

#This is A LOT & hard to read, but might be interesting for the youngest kids only. Other ages it doesn't look like there is too much to garner from modality data (it seems pretty consistent)
ggplot(aes(x=age, fill=interaction(modality,success)), data=discourse_success)+geom_bar( position="dodge")+theme(legend.position="bottom")+facet_wrap(~person)+ggtitle("success, modality, person interaction freq")

smaller_data<-discourse_success %>%
  filter(age==14)

ggplot(aes(x=age, fill=interaction(modality,success)), data=smaller_data)+geom_bar( position="dodge")+theme(legend.position="bottom")+facet_wrap(~person)+ggtitle("14mos interaction")
```

