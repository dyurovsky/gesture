---
title: "Burstiness in LDP"
author: " Maddie Meyers and Dan Yurovsky"
date: "`r Sys.Date()`"
output: 
  html_document:
  toc: false
number_sections: false
theme: lumen
toc_float: false
code_folding: hide
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(langcog)
library(stringr) 
library(lme4)
library(directlabels)
library(DT)
library(broom)
library(data.table)
library(ggplot2)
library(forcats)
library(feather)
library(tidytext)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = TRUE, tidy = FALSE)

theme_dy <- function(base_size = 14) 
{
  theme_bw() +   
    ggplot2::`%+replace%`(ggplot2::theme_bw(base_size = base_size),
                          ggplot2::theme(panel.grid = ggplot2::element_blank(), 
                                         legend.position = "none"))
}

theme_set(theme_dy())
```

## R Markdown

Setting up data
```{r load_data}
# Original data
loaded_subjs <- read_feather("feathers/loaded_subjs_full.feather")
# Referents and their frequencies
referents <- read_feather("feathers/referents.feather")
# End result of splitting referents and coding modality
coded_responses <- read_feather("feathers/coded_responses.feather")
```

##Zipfian Distributions 

```{r zipfs}
person_freqs <- coded_responses %>%
  group_by(subj, age, person, modality, referent) %>%
  summarise(person_modality_n = n()) %>%
  group_by(subj, age, referent) %>%
  mutate(total_n = sum(person_modality_n)) 

ranks <- person_freqs %>%
  arrange(subj, age, desc(total_n)) %>%
  distinct(subj, age, referent, .keep_all = TRUE) %>% 
  group_by(subj, age) %>% 
  mutate(rank = 1:n()) %>%
  select(subj, age, referent, rank)

freq_ranks <- left_join(person_freqs, ranks)

#modality and age
ggplot(filter(freq_ranks, modality != "both"), 
       aes(x = rank, y = person_modality_n, 
                  color = as.factor(age), linetype = modality)) + 
  facet_grid(~person) + 
  #geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_x_log10() + 
  scale_y_log10() +
  theme_classic()
   
person_zipfs <- freq_ranks %>%  
  filter(modality != "both") %>%
  group_by(person, modality) %>%
  do(tidy(lmer(log(person_modality_n) ~ log(rank)*age + (log(rank) + age|subj), data = .))) 


ggplot(filter(person_zipfs, term %in% c("(Intercept)", "age", "log(rank)", "log(rank):age")),
       aes(x = modality, y = estimate, color = person)) + 
  facet_wrap(~ term, scales = "free") + 
  geom_hline(yintercept = 0, lty = 2) + 
  geom_pointrange(aes(ymin = estimate-std.error, ymax = estimate+std.error),
                      position = position_dodge(.5)) + 
  theme_bw()

person_zipfs <- freq_ranks %>%  
  filter(modality != "both") %>%
  group_by(person, modality) %>%
  do(tidy(lmer(log(person_modality_n) ~ log(rank)*age + (log(rank) + age|subj), data = .))) 


ggplot(filter(person_zipfs, term %in% c("(Intercept)", "age", "log(rank)", "log(rank):age")),
       aes(x = modality, y = estimate, color = person)) + 
  facet_wrap(~ term, scales = "free") + 
  geom_hline(yintercept = 0, lty = 2) + 
  geom_pointrange(aes(ymin = estimate-std.error, ymax = estimate+std.error),
                      position = position_dodge(.5)) + 
  theme_bw()
```

##Main Topic Analysis 
Here, we wanted to see if we could break down the data for if it introduced a new topic or not. The topics were marked by whether the difference between successive mentions of the same topic was greater or less than predicted under a random-chance frequency-dependent model. In this analysis, we underestimated what was included in a topic by marking referents that were mentioned significantly sooner than expected as being part of the same topic. This underestimation was so great that for some referents, even if the difference was 1 it was not classified as in the same topic. 

We then fit a model to see if factors like age, modality, and person (parent/child) were significant in predicting whether a referent was part of the same topic. 

```{r intervals}
intervals <- coded_responses %>%
  group_by(subj, age, referent) %>%
  arrange(time) %>%
  summarise(freq = n(), times = paste0(diff(as.numeric(time)), collapse = " ")) %>%
  unnest_tokens(diff, times)

annotated_intervals <- coded_responses %>%
  group_by(subj, age, referent) %>%
  mutate(freq = n()) %>%
  filter(freq > 1) %>%
  arrange(subj, age, referent, time) %>%
  slice(2:n()) %>%
  ungroup() %>%
  select(time, person, modality, freq_cut) %>%
  bind_cols(intervals, .) %>%
  mutate(diff = as.numeric(diff)) %>%
  group_by(subj, age) %>%
  mutate(total_refs = n(),
         predicted = total_refs/freq,
         prob_extreme = pexp(diff, rate = freq/total_refs, 
                             lower.tail = T, log.p = T),
         old_topic = prob_extreme < log(.05)) %>% #underestimates new_topic
  ungroup() %>%
  mutate(modality = factor(modality, levels = c("speech", "gesture", "both")))

old_topic_model <- glmer(old_topic ~ age*person*modality + log(freq)  +
                            (1|subj), 
      family = "binomial", data = annotated_intervals)

hist(exp(annotated_intervals$prob_extreme))

old_topic_model_simple <- glmer(old_topic ~ scale(log(age)) * person * modality * scale(log(freq))  +
                            (1|subj), 
      family = "binomial", data = filter(annotated_intervals, modality != "both"))


old_topic_model_parent <- glmer(old_topic ~ scale(log(age))  * scale(log(freq)) +
                            (1|subj), 
      family = "binomial", data = filter(annotated_intervals, modality != "both", person == "parent"))


summary(old_topic_model_simple)

summary(old_topic_model)

old_topic_prob <- annotated_intervals %>%
  group_by(age, person, subj) %>%
  summarise(old_topic = mean(old_topic)) %>%
  summarise(sem = sd(old_topic)/sqrt(n()-1), old_topic = mean(old_topic))


ggplot(old_topic_prob, aes(x = age, y = old_topic, color = person, label= person)) + 
  geom_pointrange(aes(ymin = old_topic - sem, ymax = old_topic + sem), position = position_dodge(.25)) + 
  geom_dl(method = "smart.grid")

old_topic_prob <- annotated_intervals %>%
  filter(modality != "both") %>% 
  group_by(age, modality,  person, freq_cut, subj, referent) %>% 
  summarise(old_topic = mean(old_topic)) #%>%
   summarise(old_topic = mean(old_topic))# %>%
  # summarise(old_topic = mean(old_topic)) %>%
  # summarise(old_topic = mean(old_topic))

ggplot(old_topic_prob, aes(x = freq_cut, y = old_topic, color =modality, label = modality,
                           group = modality)) + 
  facet_grid(age~ person) +
  geom_smooth() +
  geom_dl(method = "last.qp")


```

```{r- one way representations}
#age/old_topic--model says that as age increases, # of old_topics decrease
#is probably masked by other effects
#one of the problems we might have is just that the number/proportion of old_topic items is changing with age (bell-shape, more old topics at middle ages and not beginning or end)
age_old_topic<-annotated_intervals %>%
  group_by(age, old_topic) %>%
  summarise(n = n()) %>% 
  mutate(prob = n/sum(n)) 

ggplot(age_old_topic, aes(x = age, y = prob, color=old_topic)) + 
  geom_point(stat="identity") +
  geom_line()+
  scale_x_continuous(breaks= c(14, 18, 22, 26, 30, 34)) +
  theme(legend.position= "bottom") + 
  ylab("old_topic proportion") +
  ggtitle("Age vs. Old_Topic")

#modality vs. old_topic (not what expected)
mod_old_topic<-annotated_intervals %>%
  filter(modality != "both") %>%
  group_by(modality, old_topic) %>%
  summarise(n = n()) %>% 
  mutate(prob = n/sum(n)) 

ggplot(mod_old_topic, aes(x = modality, y = prob, fill=old_topic)) + 
  geom_bar(stat="identity") +
  theme(legend.position= "bottom") + 
  ylab("old_topic proportion") +
  ggtitle("Modality vs. Old_Topic")

```

```{r- two-way interaction representations}
#age/person/old_topic
person_old_topic<- annotated_intervals%>%
  filter(modality != "both") %>%
  group_by(age, person, old_topic) %>%
  summarize(n=n()) %>%
  mutate(prob=n/sum(n))

ggplot(person_old_topic, aes(x = age, y = prob, fill=person)) + 
  geom_bar(stat="identity", position="dodge") +
  facet_wrap(~old_topic)+
  scale_x_continuous(breaks= c(14, 18, 22, 26, 30, 34)) +
  theme(legend.position= "bottom") + 
  ylab("old_topic probability")

#age/modality/old_topic
modality_old_topic<- annotated_intervals%>%
  filter(modality != "both") %>%
  group_by(age, modality, old_topic) %>%
  summarize(n=n()) %>%
  mutate(prob=n/sum(n)) 

ggplot(modality_old_topic, aes(x = age, y = prob, fill=modality)) + 
  geom_bar(stat="identity", position="dodge") +
  facet_wrap(~old_topic)+
  scale_x_continuous(breaks= c(14, 18, 22, 26, 30, 34)) +
  theme(legend.position= "bottom") + 
  ylab("old_topic probability")

#person/modality (AS EXPECTED)
#modality:gesture reduces the effect of person:parent on prob old_topic to where it is only slightly negative
modality_person_old_topic<- annotated_intervals%>%
  filter(modality != "both") %>%
  group_by(subj, person, modality, old_topic) %>%
  summarize(n=n()) %>%
  mutate(prob=n/sum(n)) 

ggplot(modality_person_old_topic, aes(x = person, y = prob, fill=modality)) + 
  geom_bar(stat="identity", position="dodge") +
  facet_wrap(~old_topic)+
  theme(legend.position= "bottom") + 
  ylab("old_topic probability")
```

```{r- three way interaction representation}
# is this possible? 
#age/modality/person/old_topic
#old_topic=TRUE, see proportion
#age is x axis 

three_way<-annotated_intervals %>%
  filter(modality != "both") %>%
  group_by(age, person, modality, old_topic) %>%
  summarize(n=n()) %>%
  mutate(prob=n/sum(n)) %>%
  filter(old_topic==TRUE)

#does this actually have any meaning? probably not
ggplot(three_way, aes(x=age, y=modality, fill=prob)) +
  geom_tile()+
  scale_x_continuous(breaks= c(14, 18, 22, 26, 30, 34)) +
  facet_grid(~person)+
  theme(legend.position="bottom")

```

Old code that calculated predicted difference by using means. Has been replaced by above interval code
```{r}
intervals %>%
  group_by(freq, age, subj, referent) %>%
  summarise(diff = median(diff-predicted)) %>%
  summarise(diff = mean(diff)) %>%
  summarise(diff = mean(diff)) %>%
  ggplot(aes(x = freq, y = diff, color = as.factor(age))) + 
    geom_point() + 
    geom_smooth(se = FALSE) + 
    scale_x_log10() + 
  geom_hline(yintercept = 0, lty = 2) +
  # scale_y_log10() +
    theme_bw()


diff_lm <- lmer((diff-predicted) ~ log(freq) + age + log(freq)*age +
                   (log(freq)|subj), data = intervals)


intervals %>%
  group_by(freq, age, subj, referent) %>%
  summarise(new_topic = mean(new_topic)) %>%
  summarise(new_topic = mean(new_topic)) %>%
  summarise(new_topic = mean(new_topic)) %>%
  ggplot(aes(x = freq, y = new_topic, color = as.factor(age))) + 
    geom_point() + 
    geom_smooth(se = FALSE, method = "lm") + 
    scale_x_log10() + 
  geom_hline(yintercept = 0, lty = 2) +
  # scale_y_log10() +
    theme_bw()

diff_logit <- glmer(new_topic ~ log(freq) + age + (1|subj),
                   family = "binomial", data = intervals)
```

##Gleitman Plots
A way of representing how referents shift during a conversation. We tried to use these to see topic shifts but they were not entirely useful. 

```{r}
runs <- coded_responses %>%
  select(subj, age, referent, time) %>%
  arrange(subj, age, referent, time) %>%
  group_by(subj, age, referent) %>%
  mutate(diff = time-lag(time)) %>%
  filter(diff < 10 & diff > 1)

fixed_runs <- map(1:100, function(row) {
  times <- 1:(runs[row,]$diff-1) + runs[row,]$time
  
  data_frame(time = times, subj = runs[row,]$subj, age = runs[row,]$age, 
             referent = runs[row,]$referent)}) %>%
  bind_rows() %>%
  bind_rows(runs)
```

```{r}
gleit<-fixed_runs %>%
  filter(subj==29, age==22)#arbitrary choice

gleit_order <- gleit %>%
  ungroup() %>%
  group_by(referent) %>%
  arrange(time) %>%
  slice(1) %>%
  arrange(time) 

gleit_ordered <- gleit %>%
  mutate(referent = factor(referent, levels = gleit_order$referent))

ggplot(gleit_ordered, aes(x = as.factor(time), y = referent)) + 
  geom_tile(fill = "black", color = "white") + 
  theme(legend.position = "none")+
  scale_x_discrete(breaks= c(seq(from = 1, to = 1000, by = 10)))

```

